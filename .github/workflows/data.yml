name: Post Merged PRs to Slack

on:
  pull_request:
    types: [closed]

jobs:
  post-merged-prs:
    if: github.event.pull_request.merged == true # Only run if the pull request was merged
    runs-on: ubuntu-latest
    
    steps:
    - name: Get Merged PRs
      id: get_prs
      uses: actions/github-script@v5
      with:
        script: |
          const response = await github.request('GET /repos/{owner}/{repo}/pulls', {
            owner: context.repo.owner,
            repo: context.repo.repo,
            state: 'closed',
            base: 'master',
            per_page: 1
          });
          const mergedPRs = response.data.filter(pr => pr.merged_at);
          if (mergedPRs.length > 0) {
            const prList = mergedPRs.map(pr => `- ${pr.title} (#${pr.number}) by ${pr.user.login}: ${pr.html_url}`).join('\n');
            console.log(prList);
            core.setOutput('merged_pr_list', prList);
          } else {
            core.setOutput('merged_pr_list', ''); // If no merged PRs found, set output to empty string
          }

    - name: Post to Slack
      if: steps.get_prs.outputs.merged_pr_list != '' # Only run if there are merged PRs
      env:
        SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}
        SLACK_CHANNEL: '#test' 
      run: |
        PR_LIST=$(echo "${{ steps.get_prs.outputs.merged_pr_list }}")
        JSON="{\"text\": \"Merged Pull Requests:\n$PR_LIST\", \"channel\": \"$SLACK_CHANNEL\"}"
        curl -X POST -H 'Content-type: application/json' --data "$JSON" $SLACK_WEBHOOK_URL
